name: Build Monorepo (Linux)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Isolate vcpkg to the workspace (good practice for CI)
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      # Tell vcpkg where to store/find binary cache
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------
    # 1. Install Ninja
    # ------------------------------
    # CMake Presets default to Ninja on Linux. It is faster than Make.
    - name: Install Ninja
      run: sudo apt-get install -y ninja-build

    # ------------------------------
    # 2. Setup Vcpkg
    # ------------------------------
    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        $VCPKG_ROOT/bootstrap-vcpkg.sh

    # ------------------------------
    # 3. Cache Binary Artifacts
    # ------------------------------
    # We cache the compiled libraries to speed up future builds.
    # Note: We use a local path inside workspace for easier permission handling.
    - name: Cache vcpkg binaries
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        # The key depends on the manifest. If vcpkg.json changes, cache invalidates.
        key: ${{ runner.os }}-vcpkg-bin-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-bin-

    # ------------------------------
    # 4. Create Cache Directory
    # ------------------------------
    # Vcpkg needs this directory to exist before it tries to write to it.
    - name: Create Cache Dir
      run: mkdir -p $VCPKG_DEFAULT_BINARY_CACHE

    # ------------------------------
    # 5. Configure (The Recipe)
    # ------------------------------
    # This reads vcpkg.json, installs dependencies, and generates build files.
    - name: Configure via Preset
      run: cmake --preset vcpkg-release

    # ------------------------------
    # 6. Build (The Cooking)
    # ------------------------------
    # This builds every target defined in your root CMakeLists.txt
    - name: Build via Preset
      run: cmake --build --preset vcpkg-release